name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build with Maven
      run: mvn clean install
    
    - name: Run tests
      run: mvn test
    
    - name: Create Issue and notify team on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues. create({
            owner: context. repo. owner,
            repo: context. repo.repo,
            title: 'CI Build Failed - ' + context.sha.substring(0, 7),
            body: `## Build nie powiódł się! 
            
            **Branch:** \`${context.ref}\`  
            **Commit:** \`${context.sha}\`  
            **Autor:** @${context.actor}  
            **Data:** ${new Date().toLocaleString('pl-PL')}
            
            ### Szczegóły:
            - **Repository:** ${context.repo.owner}/${context.repo.repo}
            - **Workflow:** ${context.workflow}
            - **Job:** ${context.job}
            
            ### Zobacz logi:
            [Kliknij tutaj aby zobaczyć pełne logi](${context.serverUrl}/${context.repo.owner}/${context. repo.repo}/actions/runs/${context.runId})
            
            ### Powiadomiono:
            - @Al3xBlack0ut
            - @abzediusz
            - @PiotrRem
            
            ---
            *Issue utworzony automatycznie przez GitHub Actions CI*
            *Wszyscy przypisani członkowie otrzymają email z powiadomieniem*`,
            labels: ['bug', 'ci-failure', 'high-priority'],
            assignees: [
              'Al3xBlack0ut',
              'abzediusz',
              'PiotrRem'
            ]
          });
          
          console.log('Issue utworzony:', issue.data.html_url);
          console.log('Email wysłany do przypisanych osób');
    
    - name: Close failure issues on success
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const issues = await github.rest. issues. listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ci-failure'
          });
          
          for (const issue of issues. data) {
            await github. rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: ` **Build został naprawiony! **\n\n**Commit:** \`${context.sha}\`\n**Autor:** @${context.actor}\n\n[Zobacz workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
              state_reason: 'completed'
            });
            
            console.log(' Zamknięto Issue:', issue.number);
          }
